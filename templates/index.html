<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div>
        <h1 class="pc-title">åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</h1>
        <h1 class="mobile-title">è”µå‡ºã—ã‚¯ãƒ©ã‚¦ãƒ‰</h1>
        
        <nav>
            <a href="{{ url_for('register') }}" class="main-button">â•å‡ºåº«æƒ…å ±ã®æ‰‹å‹•ç™»éŒ²</a>
            |
            <a href="{{ url_for('list_data') }}">ğŸ“‹å‡ºåº«æƒ…å ±ä¸€è¦§ (ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ)</a>
            |
            <a href="/email">ğŸ“§ åœ¨åº«æƒ…å ±ãƒ¡ãƒ¼ãƒ«é€ä¿¡</a>
            |
            <a href="{{ url_for('show_data') }}">ğŸ“„ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ç¢ºèª (DB)</a>
        </nav>

        <hr>
        <div id="csv-upload-section"> 
            <h2>åº—é ­è²©å£²CSVãƒ‡ãƒ¼ã‚¿ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            <p>ã‚¹ãƒãƒ¬ã‚¸ã‹ã‚‰å‡ºåŠ›ã—ãŸå£²ä¸ŠCSVãƒ•ã‚¡ã‚¤ãƒ« (ä¾‹: `20240521-uriage.csv`) ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>
            
            <form id="upload-form">
                <!-- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ã®ã‚¨ãƒªã‚¢ -->
                <div id="drop-zone" style="border: 2px dashed #ccc; padding: 25px; text-align: center;">
                    <p>ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <p>ã¾ãŸã¯</p>
                    <!-- æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ -->
                    <input type="file" name="file" id="file-input" accept=".csv" required>
                    <!-- é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ -->
                    <p id="file-info" style="margin-top: 15px; font-weight: bold;"></p>
                </div>
                <button type="submit" style="margin-top: 10px;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å‡¦ç†ã‚’é–‹å§‹</button>
            </form>

            <div id="loader" style="display: none;">å‡¦ç†ä¸­ã§ã™...</div>
            <div id="result-message"></div>
        </div>
    </div>

    <script>
        // --- ã“ã“ã‹ã‚‰ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ã®è¿½åŠ  ---

        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ–ãƒ©ã‚¦ã‚¶å‹•ä½œã‚’ç„¡åŠ¹åŒ–
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false); // ç”»é¢å…¨ä½“ã§ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚’é˜²ã
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = 'blue';
                dropZone.style.backgroundColor = '#f0f8ff';
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = '#ccc';
                dropZone.style.backgroundColor = 'transparent';
            }, false);
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒ1ã¤ä»¥ä¸Šã‚ã‚Œã°ã€inputã«ã‚»ãƒƒãƒˆã™ã‚‹
            if (files.length) {
                fileInput.files = files;
                updateFileInfo(); // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã‚‰ï¼ˆãƒœã‚¿ãƒ³çµŒç”±ã§ã‚‚ãƒ‰ãƒ­ãƒƒãƒ—çµŒç”±ã§ã‚‚ï¼‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º
        fileInput.addEventListener('change', updateFileInfo);

        function updateFileInfo() {
            if (fileInput.files.length > 0) {
                fileInfo.textContent = `é¸æŠä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«: ${fileInput.files[0].name}`;
            } else {
                fileInfo.textContent = '';
            }
        }

        // --- ã“ã“ã¾ã§ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ ---


        // --- æ—¢å­˜ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† ---
        document.getElementById('upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = e.target;
            const resultDiv = document.getElementById('result-message');
            const loader = document.getElementById('loader');
            
            resultDiv.innerHTML = ''; // å‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            if (fileInput.files.length === 0) {
                resultDiv.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            loader.style.display = 'block';
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch("{{ url_for('upload_file') }}", {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    if (result.status === 'confirm') {
                        // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                        resultDiv.innerHTML = `<p>${result.message}</p><button id="confirm-btn">ã¯ã„ã€ç¶šè¡Œã—ã¾ã™</button>`;
                        
                        document.getElementById('confirm-btn').addEventListener('click', async () => {
                            loader.style.display = 'block';
                            resultDiv.innerHTML = 'å†å‡¦ç†ä¸­ã§ã™...';

                            const confirmFormData = new FormData();
                            confirmFormData.append('filename', result.filename);
                            confirmFormData.append('file_hash', result.file_hash);

                            const confirmResponse = await fetch("{{ url_for('confirm_upload') }}", {
                                method: 'POST',
                                body: confirmFormData
                            });
                            
                            const confirmResult = await confirmResponse.json();
                            if (confirmResponse.ok && confirmResult.success) {
                                resultDiv.textContent = confirmResult.success;
                            } else {
                                resultDiv.textContent = (confirmResult && confirmResult.error) || 'å†å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                            }
                            loader.style.display = 'none';
                        });
                    } else if (result.success) {
                        resultDiv.textContent = result.success;
                    } else { 
                        resultDiv.textContent = result.error || 'å‡¦ç†ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                    }
                } else { // HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ4xx, 5xxã®å ´åˆ
                    resultDiv.textContent = result.error || `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (ã‚³ãƒ¼ãƒ‰: ${response.status})ã€‚`;
                }
            } catch (error) {
                resultDiv.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                console.error('Error:', error);
            } finally {
                // ç¢ºèªãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’æ¶ˆã™
                if (!document.getElementById('confirm-btn')) {
                    loader.style.display = 'none';
                }
                form.reset(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                updateFileInfo(); // ãƒ•ã‚¡ã‚¤ãƒ«åè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
            }
        });
    </script>
</body>
</html>